<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NetPal SMM – Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root {
      --bg: #02040a;
      --card: #050915;
      --primary: #007CB6;
      --primary-dark: #002F7A;
      --text: #ffffff;
      --muted: #a4acb9;
      --radius: 18px;
      --shadow: 0 18px 40px rgba(0,0,0,0.55);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Baloo Bhaijaan 2", system-ui, sans-serif;
      background: radial-gradient(circle at top, #050915, #000000 60%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .card {
      width: min(900px, 100%);
      background: var(--card);
      border-radius: 28px;
      box-shadow: var(--shadow);
      padding: 26px 24px 24px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo img {
      width: 38px;
      height: 38px;
    }

    .logo-title {
      font-size: 1.2rem;
    }

    .badge {
      font-size: 0.8rem;
      color: var(--muted);
    }

    h2 {
      margin-bottom: 8px;
      font-size: 1.4rem;
    }

    p {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .section {
      margin-top: 18px;
    }

    .hidden {
      display: none !important;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border-radius: 999px;
      border: none;
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff;
      cursor: pointer;
      font-size: 0.95rem;
      box-shadow: var(--shadow);
    }

    textarea {
      width: 100%;
      min-height: 260px;
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: #02040a;
      color: #fff;
      font-size: 0.9rem;
      padding: 10px 12px;
      font-family: monospace;
      resize: vertical;
      white-space: pre;
    }

    .status {
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .status.ok {
      color: #70e19f;
    }

    .status.err {
      color: #ff8080;
    }

    .top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 12px;
    }

    .top-row .btn {
      padding-inline: 16px;
      font-size: 0.86rem;
    }

    .small {
      font-size: 0.8rem;
      color: var(--muted);
    }

    @media (max-width: 600px) {
      .card { padding: 18px 16px 18px; }
      h2 { font-size: 1.25rem; }
    }
  </style>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="card">
    <div class="card-header">
      <div class="logo">
        <img src="images/logo-netpal-smm.png" alt="">
        <div>
          <div class="logo-title">NetPal SMM – Admin</div>
          <div class="badge">Only <strong>netpalsuper7@gmail.com</strong> is allowed</div>
        </div>
      </div>
      <div id="userInfo" class="small"></div>
    </div>

    <!-- SIGN IN SECTION -->
    <div id="loginSection" class="section">
      <h2>Sign in</h2>
      <p>Sign in with your Google account to manage <code>services.json</code>.</p>

      <div id="g_id_onload"
           data-client_id="886540598530-t5ocfg0jfa14vlv83qv0co8qrjnsbjt9.apps.googleusercontent.com"
           data-callback="handleGoogleResponse"
           data-context="signin"
           data-auto_select="false"
           data-itp_support="true">
      </div>
      <div class="g_id_signin"
           data-type="standard"
           data-shape="rectangular"
           data-theme="outline"
           data-text="signin_with"
           data-size="large"
           data-logo_alignment="left">
      </div>

      <p class="small" style="margin-top:12px;">
        Tip: make sure this page is opened from<br>
        <code>https://danibtr.github.io/NetpalSMM_website/admin.html</code>
      </p>
    </div>

    <!-- ADMIN SECTION -->
    <div id="adminSection" class="section hidden">
      <h2>services.json editor</h2>
      <p>Edit your services here. Make sure it stays valid JSON (you can use <a href="https://jsonlint.com" target="_blank">jsonlint.com</a> to check).</p>

      <div class="top-row">
        <button class="btn" type="button" id="btnReload">
          <i class="fa-solid fa-rotate-right"></i> Reload from GitHub
        </button>
        <button class="btn" type="button" id="btnSave">
          <i class="fa-solid fa-cloud-arrow-up"></i> Save to GitHub
        </button>
      </div>

      <textarea id="jsonArea" spellcheck="false"></textarea>
      <div id="status" class="status">Waiting…</div>

      <p class="small" style="margin-top:8px;">
        On first save, you will be asked for your <strong>GitHub personal access token</strong>.
        It is only kept in memory in this browser tab and never stored in the code.
      </p>
    </div>
  </div>

  <script>
    const ALLOWED_EMAIL = "netpalsuper7@gmail.com";

    const OWNER = "danibtr";
    const REPO = "NetpalSMM_website";
    const FILE_PATH = "services.json";
    const BRANCH = "main"; // غيّرها لـ master إذا كان البرانش عندك master

    let githubToken = null;
    let fileSha = null;

    const loginSection = document.getElementById('loginSection');
    const adminSection = document.getElementById('adminSection');
    const jsonArea = document.getElementById('jsonArea');
    const statusEl = document.getElementById('status');
    const userInfo = document.getElementById('userInfo');

    function setStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (type || '');
    }

    function decodeJwt(token) {
      const payload = token.split('.')[1];
      const base64 = payload.replace(/-/g, '+').replace(/_/g, '/');
      const json = atob(base64);
      return JSON.parse(json);
    }

    // called by Google Identity
    window.handleGoogleResponse = async function (response) {
      try {
        const data = decodeJwt(response.credential);
        if (data.email !== ALLOWED_EMAIL) {
          alert("This admin is only for " + ALLOWED_EMAIL + ". You signed in as " + data.email);
          return;
        }
        userInfo.textContent = data.email;
        loginSection.classList.add('hidden');
        adminSection.classList.remove('hidden');
        setStatus("Signed in. Loading services.json from GitHub…");
        await loadFromGithub();
      } catch (e) {
        console.error(e);
        alert("Error while processing Google login.");
      }
    };

    async function gitFetch(path, options = {}) {
      const url = `https://api.github.com/repos/${OWNER}/${REPO}${path}`;
      const headers = Object.assign({
        "Accept": "application/vnd.github+json"
      }, options.headers || {});

      if (githubToken) {
        headers["Authorization"] = "Bearer " + githubToken;
      }

      const res = await fetch(url, Object.assign({}, options, { headers }));
      return res;
    }

    async function loadFromGithub() {
      try {
        const res = await gitFetch(`/contents/${FILE_PATH}?ref=${BRANCH}`);
        if (!res.ok) {
          const t = await res.text();
          throw new Error("GitHub GET failed: " + t);
        }
        const json = await res.json();
        fileSha = json.sha;
        const content = atob(json.content.replace(/\n/g, ''));
        jsonArea.value = content;
        setStatus("Loaded services.json from GitHub.", "ok");
      } catch (err) {
        console.error(err);
        setStatus("Failed to load from GitHub. Check repo name/branch/path.", "err");
      }
    }

    async function saveToGithub() {
      try {
        // تأكد إن JSON صحيح
        let parsed;
        try {
          parsed = JSON.parse(jsonArea.value);
        } catch (e) {
          alert("services.json is not valid JSON. Please fix it first.");
          return;
        }

        if (!githubToken) {
          githubToken = prompt("Enter your GitHub Personal Access Token:");
          if (!githubToken) {
            alert("Token is required to save.");
            return;
          }
        }

        if (!fileSha) {
          await loadFromGithub();
          if (!fileSha) throw new Error("Missing file SHA");
        }

        const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(parsed, null, 2))));

        setStatus("Saving to GitHub…");
        const res = await gitFetch(`/contents/${FILE_PATH}`, {
          method: "PUT",
          body: JSON.stringify({
            message: "Update services.json via NetPal SMM admin",
            content: encoded,
            sha: fileSha,
            branch: BRANCH
          })
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error("GitHub PUT failed: " + txt);
        }

        const data = await res.json();
        fileSha = data.content.sha;
        setStatus("Saved successfully to GitHub.", "ok");
        alert("services.json updated successfully.");
      } catch (err) {
        console.error(err);
        setStatus("Error while saving: " + err.message, "err");
      }
    }

    document.getElementById('btnReload').addEventListener('click', loadFromGithub);
    document.getElementById('btnSave').addEventListener('click', saveToGithub);
  </script>
</body>
</html>
